<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>กราฟเวลาว่ายน้ำ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h2>กราฟเวลาการว่ายน้ำ (นาที:วินาที)</h2>
  <canvas id="swimChart" width="400" height="200"></canvas>

  <script>
    async function fetchCSVData() {
      const response = await fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vQXQPJcv3QOojPp1uw4-lpD_i0d3KnHRgdCibq9T23VsMS75Fe_wDEQG7_7sFFhowP6Jy7lJCvPDw4r/pub?gid=1712641251&single=true&output=csv");
      const data = await response.text();
      const rows = data.trim().split('\n').slice(1); // ข้ามหัวตาราง
      const labels = [];
      const timesInSeconds = [];

      rows.forEach((row, index) => {
        const columns = row.split(',');
        const date = columns[0]?.trim();
        const time = columns[2]?.trim(); // ช่องที่ 3 คือเวลา

        if (!time || !time.includes(':')) {
          console.warn(`❌ ข้อมูลแถว ${index + 2} ไม่ถูกต้อง:`, row);
          return;
        }

        const [minutes, seconds] = time.split(':').map(Number);

        if (isNaN(minutes) || isNaN(seconds)) {
          console.warn(`❌ เวลาไม่ใช่ตัวเลข: ${time}`);
          return;
        }

        const totalSeconds = minutes * 60 + seconds;
        labels.push(date);
        timesInSeconds.push(totalSeconds);
      });

      return { labels, timesInSeconds };
    }

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    async function createChart() {
      const { labels, timesInSeconds } = await fetchCSVData();

      const ctx = document.getElementById('swimChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'เวลาการว่ายน้ำ',
            data: timesInSeconds,
            borderColor: 'blue',
            backgroundColor: 'rgba(135, 206, 250, 0.4)',
            tension: 0.2,
            pointRadius: 5,
            fill: true,
          }]
        },
        options: {
          scales: {
            y: {
              ticks: {
                callback: function(value) {
                  return formatTime(value);
                }
              },
              title: {
                display: true,
                text: 'เวลา (นาที:วินาที)'
              }
            },
            x: {
              title: {
                display: true,
                text: 'วันที่'
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  return 'เวลา: ' + formatTime(context.raw);
                }
              }
            }
          }
        }
      });
    }

    createChart();
  </script>
</body>
</html>
