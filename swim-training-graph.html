<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>กราฟเวลาว่ายน้ำ (7 วันล่าสุด)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Sarabun', sans-serif; text-align: center; padding: 20px; }
    canvas { max-width: 600px; margin: auto; }
  </style>
</head>
<body>
  <h2>กราฟเวลาว่ายน้ำ (แสดง 7 วันล่าสุด แบบนาที:วินาที)</h2>
  <canvas id="swimChart"></canvas>

  <script>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/1G05TnqQZN6i5SRTyHl8MHhnvld-t-J26tlIrca99XW0/gviz/tq?tqx=out:json";

    fetch(SHEET_URL)
      .then(response => response.text())
      .then(dataText => {
        const json = JSON.parse(dataText.substring(47).slice(0, -2));
        const rows = json.table.rows.map(row => row.c.map(c => c ? c.v : ""));

        const formattedData = rows.map(row => ({
          date: row[0],
          stroke: row[1],
          minutes: parseInt(row[2]),
          seconds: parseInt(row[3])
        })).filter(row => !isNaN(row.minutes) && !isNaN(row.seconds));

        const latest7 = formattedData.slice(-7);

        const labels = latest7.map(item => item.date);
        const dataSeconds = latest7.map(item => item.minutes * 60 + item.seconds);
        const strokeLabels = latest7.map(item => `${item.stroke} (${item.minutes}:${item.seconds.toString().padStart(2, '0')})`);

        const ctx = document.getElementById('swimChart').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: "เวลาว่ายน้ำ",
              data: dataSeconds,
              fill: false,
              borderColor: "blue",
              backgroundColor: "blue",
              tension: 0.3,
              pointRadius: 6,
              pointHoverRadius: 8
            }]
          },
          options: {
            responsive: true,
            plugins: {
              tooltip: {
                callbacks: {
                  label: (context) => strokeLabels[context.dataIndex]
                }
              }
            },
            scales: {
              y: {
                title: {
                  display: true,
                  text: "เวลา (นาที:วินาที)"
                },
                ticks: {
                  callback: function (value) {
                    const min = Math.floor(value / 60);
                    const sec = Math.round(value % 60);
                    return `${min}:${sec.toString().padStart(2, '0')}`;
                  }
                }
              },
              x: {
                title: {
                  display: true,
                  text: "วันที่"
                }
              }
            }
          }
        });
      })
      .catch(err => console.error("Error fetching data:", err));
  </script>
</body>
</html>
