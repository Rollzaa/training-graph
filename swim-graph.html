<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>กราฟแยกท่าว่ายน้ำ</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load('current', {packages: ['corechart']});
      google.charts.setOnLoadCallback(drawChart);

      function drawChart() {
        const queryString = encodeURIComponent('SELECT A, B, C, D');
        const dataSourceUrl = 'https://docs.google.com/spreadsheets/d/1G05TnqQZN6i5SRTyHl8MHhnvld-t-J26tlIrca99XW0/gviz/tq?sheet=Sheet1&headers=1&tq=' + queryString;

        const query = new google.visualization.Query(dataSourceUrl);
        query.send(function(response) {
          if (response.isError()) {
            console.error('Error: ' + response.getMessage() + ' ' + response.getDetailedMessage());
            return;
          }

          const rawData = response.getDataTable();
          const strokes = new Set();

          // เตรียมเก็บข้อมูลตามท่า
          const rowMap = new Map(); // date string => { stroke: time }

          for (let i = 0; i < rawData.getNumberOfRows(); i++) {
            const dateStr = rawData.getValue(i, 0);
            const stroke = rawData.getValue(i, 1);
            const min = rawData.getValue(i, 2);
            const sec = rawData.getValue(i, 3);

            if (!dateStr || min == null || sec == null || !stroke) continue;

            strokes.add(stroke);

            if (!rowMap.has(dateStr)) {
              rowMap.set(dateStr, {});
            }

            const timeInSec = min * 60 + sec;
            rowMap.get(dateStr)[stroke] = timeInSec;
          }

          const strokeList = Array.from(strokes);
          const data = new google.visualization.DataTable();
          data.addColumn('string', 'วันที่');

          strokeList.forEach(stroke => {
            data.addColumn('number', stroke);
            data.addColumn({ type: 'string', role: 'tooltip' });
          });

          [...rowMap.entries()].forEach(([date, strokeData]) => {
            const row = [date];
            strokeList.forEach(stroke => {
              if (strokeData[stroke] != null) {
                const time = strokeData[stroke];
                const m = Math.floor(time / 60);
                const s = time % 60;
                const label = `ท่า: ${stroke}\nเวลา: ${m}:${s.toString().padStart(2, '0')}`;
                row.push(time, label);
              } else {
                row.push(null, null);
              }
            });
            data.addRow(row);
          });

          const options = {
            title: 'เวลาว่ายน้ำแยกตามท่า',
            curveType: 'function',
            pointSize: 6,
            hAxis: { title: 'วันที่' },
            vAxis: {
              title: 'เวลา (วินาที)',
              format: 'short',
              minValue: 0
            },
            tooltip: { isHtml: true },
            legend: { position: 'bottom' },
            colors: ['#1E90FF', '#FF69B4', '#32CD32', '#FFA500']
          };

          const chart = new google.visualization.LineChart(document.getElementById('chart_div'));
          chart.draw(data, options);
        });
      }
    </script>
  </head>
  <body>
    <h2>กราฟแยกตามท่าว่ายน้ำ (พร้อมชื่อท่า + เวลา)</h2>
    <div id="chart_div" style="width: 100%; height: 500px;"></div>
  </body>
</html>
